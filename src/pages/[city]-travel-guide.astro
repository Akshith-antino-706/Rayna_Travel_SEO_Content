---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { CATEGORIES, SITE_URL } from '../utils/constants';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);
  const cities = [...new Set(allPosts.map(p => p.data.city))];

  return cities.map(city => {
    const citySlug = city.toLowerCase().replace(/\s+/g, '-');
    const cityPosts = allPosts.filter(p => p.data.city === city);
    const country = cityPosts[0]?.data.country || '';

    return {
      params: { city: citySlug },
      props: { cityName: city, country, posts: cityPosts },
    };
  });
}

const { cityName, country, posts } = Astro.props;

// Group posts by category
const postsByCategory = CATEGORIES.reduce((acc, cat) => {
  const catPosts = posts.filter(p => p.data.category === cat.id);
  if (catPosts.length > 0) {
    acc.push({ ...cat, posts: catPosts });
  }
  return acc;
}, [] as any[]);

const citySlug = cityName.toLowerCase().replace(/\s+/g, '-');

// JSON-LD
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'TravelGuide',
  name: `${cityName} Travel Guide`,
  description: `Complete travel guide to ${cityName}, ${country}. ${posts.length} expert articles covering things to do, food, hotels, visa info, and more.`,
  about: {
    '@type': 'City',
    name: cityName,
    containedInPlace: {
      '@type': 'Country',
      name: country,
    },
  },
};

const breadcrumbLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE_URL },
    { '@type': 'ListItem', position: 2, name: `${cityName} Travel Guide` },
  ],
};
---

<BaseLayout
  title={`${cityName} Travel Guide - Complete City Guide`}
  description={`Your complete guide to ${cityName}, ${country}. ${posts.length} expert articles covering attractions, food, hotels, budgets, visas, and insider tips.`}
  jsonLd={jsonLd}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />

  <!-- Hero -->
  <section class="relative bg-gradient-to-br from-gray-900 to-gray-800 text-white py-20">
    <div class="absolute inset-0 opacity-20">
      <img
        src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=1920&h=600&fit=crop&q=80"
        alt={`${cityName} skyline`}
        class="w-full h-full object-cover"
        loading="eager"
      />
    </div>
    <div class="container-wide relative text-center">
      <nav class="breadcrumb justify-center mb-6 text-gray-300">
        <a href="/" class="hover:text-white">Home</a>
        <span class="separator">/</span>
        <span class="text-white">{cityName} Travel Guide</span>
      </nav>

      <h1 class="font-heading text-4xl sm:text-5xl lg:text-6xl font-bold mb-4">
        {cityName} Travel Guide
      </h1>
      <p class="text-xl text-gray-300 mb-6">
        {country}
      </p>

      <div class="flex items-center justify-center gap-6 text-sm text-gray-300">
        <span>{posts.length} Expert Articles</span>
        <span class="text-gray-500">|</span>
        <span>{postsByCategory.length} Categories</span>
      </div>
    </div>
  </section>

  <!-- Quick Navigation -->
  <section class="bg-white border-b border-gray-200 sticky top-16 z-40">
    <div class="container-wide">
      <nav class="flex items-center gap-1 overflow-x-auto py-3 scrollbar-hide">
        {postsByCategory.map(cat => (
          <a
            href={`#${cat.id.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '')}`}
            class="flex-shrink-0 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm
                   text-gray-600 hover:bg-orange-50 hover:text-orange-600 transition-colors"
          >
            <span>{cat.icon}</span>
            {cat.label}
            <span class="text-xs text-gray-400 ml-0.5">({cat.posts.length})</span>
          </a>
        ))}
      </nav>
    </div>
  </section>

  <!-- Content by Category -->
  <div class="container-wide py-12">
    {postsByCategory.map(cat => (
      <section
        id={cat.id.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '')}
        class="mb-16 scroll-mt-32"
      >
        <div class="flex items-center gap-3 mb-6">
          <span class="text-2xl">{cat.icon}</span>
          <h2 class="font-heading text-2xl font-bold text-gray-900">{cat.label}</h2>
          <span class="badge-category">{cat.posts.length} articles</span>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {cat.posts.map(post => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.slug}
              city={post.data.city}
              category={post.data.category}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              readingTime={post.data.readingTime}
            />
          ))}
        </div>
      </section>
    ))}
  </div>

  <!-- CTA -->
  <section class="bg-orange-50 py-12">
    <div class="container-narrow text-center">
      <h2 class="font-heading text-2xl font-bold text-gray-900 mb-3">
        Ready to Explore {cityName}?
      </h2>
      <p class="text-gray-600 mb-6">
        Start planning your trip with our comprehensive guides covering every aspect of visiting {cityName}.
      </p>
      <a href="/blog?city={encodeURIComponent(cityName)}" class="btn-primary">
        Browse All {cityName} Articles
      </a>
    </div>
  </section>
</BaseLayout>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
