---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import SearchBar from '../components/SearchBar.tsx';
import { getCollection } from 'astro:content';
import { SITE_TITLE, SITE_DESCRIPTION, SITE_URL, CATEGORIES } from '../utils/constants';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const cities = [...new Set(allPosts.map(p => p.data.city))];

// Featured Posts: prefer featured=true, spread across cities
const featuredPosts = sortedPosts.filter(p => p.data.featured).slice(0, 4);
const featuredCities = new Set(featuredPosts.map(p => p.data.city));
const fillPosts = sortedPosts
  .filter(p => !p.data.featured && !featuredCities.has(p.data.city))
  .slice(0, 4 - featuredPosts.length);
const selectedFeatured = [...featuredPosts, ...fillPosts].slice(0, 4);

// Popular guides: deduplicated from featured section
const guidePosts = sortedPosts
  .filter(p => !selectedFeatured.some(f => f.slug === p.slug))
  .slice(0, 4);

const searchData = allPosts.map(p => ({
  title: p.data.title,
  description: p.data.description,
  slug: p.slug,
  city: p.data.city,
  category: p.data.category,
  tags: p.data.tags,
  readingTime: p.data.readingTime,
}));

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: SITE_TITLE,
  description: SITE_DESCRIPTION,
  url: SITE_URL,
  potentialAction: {
    '@type': 'SearchAction',
    target: `${SITE_URL}/blog?q={search_term_string}`,
    'query-input': 'required name=search_term_string',
  },
};
---

<BaseLayout jsonLd={jsonLd}>
  <!-- 1. Hero -->
  <section class="relative h-[420px] sm:h-[500px] overflow-hidden">
    <img
      src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=1920&h=600&fit=crop&q=80"
      alt="Dubai skyline at sunset"
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-black/10"></div>
    <div class="container-wide relative h-full flex flex-col justify-end pb-12">
      <h1 class="text-white text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight max-w-2xl mb-3">
        Explore Our<br />Travel Guides
      </h1>
      <p class="text-white/80 text-sm sm:text-base max-w-lg mb-6">
        Expert guides, insider tips, and comprehensive itineraries for {cities.length}+ destinations worldwide.
      </p>
      <div class="max-w-lg">
        <SearchBar articles={searchData} client:load />
      </div>
    </div>
  </section>

  <!-- 2. Browse by Category (moved up for quick navigation) -->
  <section class="bg-gray-50 py-10">
    <div class="container-wide">
      <h2 class="section-title mb-4">Browse by Category</h2>
      <div class="scroll-row gap-3">
        {CATEGORIES.slice(0, 10).map(cat => (
          <a
            href={`/blog?category=${encodeURIComponent(cat.id)}`}
            class="flex-shrink-0 flex items-center gap-2 px-4 py-2.5 bg-white rounded-full border border-gray-100
                   hover:bg-orange-50 hover:border-orange-200 transition-colors text-sm text-gray-600 hover:text-orange-600"
          >
            <span>{cat.icon}</span>
            <span class="font-medium">{cat.label}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- 3. Featured Travel Posts (1 large + 3 horizontal) -->
  <section class="py-10">
    <div class="container-wide">
      <div class="flex items-center justify-between mb-6">
        <h2 class="section-title">Featured Travel Posts</h2>
        <a href="/blog" class="text-xs text-orange-500 font-medium hover:underline">View All</a>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {selectedFeatured.length > 0 && (
          <BlogCard
            title={selectedFeatured[0].data.title}
            description={selectedFeatured[0].data.description}
            slug={selectedFeatured[0].slug}
            city={selectedFeatured[0].data.city}
            category={selectedFeatured[0].data.category}
            pubDate={selectedFeatured[0].data.pubDate}
            heroImage={selectedFeatured[0].data.heroImage}
            readingTime={selectedFeatured[0].data.readingTime}
            featured={true}
          />
        )}
        <div class="space-y-5">
          {selectedFeatured.slice(1, 4).map(post => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.slug}
              city={post.data.city}
              category={post.data.category}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              readingTime={post.data.readingTime}
              variant="horizontal"
            />
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- 4. Explore Travel Guides (city grid) -->
  <section class="bg-gray-50 py-10">
    <div class="container-wide">
      <h2 class="section-title mb-1">Explore Travel Guides</h2>
      <p class="section-subtitle">Comprehensive city guides covering attractions, food, hotels, and more</p>

      <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-3">
        {cities.map(city => {
          const citySlug = city.toLowerCase().replace(/\s+/g, '-');
          const count = allPosts.filter(p => p.data.city === city).length;
          return (
            <a href={`/${citySlug}-travel-guide`} class="group relative rounded-xl overflow-hidden aspect-[4/3]">
              <img
                src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=300&h=225&fit=crop&q=70"
                alt={city}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
              <div class="absolute bottom-2 left-2.5 right-2">
                <h3 class="text-white font-bold text-sm">{city}</h3>
                <p class="text-white/70 text-[10px]">{count} articles</p>
              </div>
            </a>
          );
        })}
      </div>
    </div>
  </section>

  <!-- 5. Popular Travel Guides (1 large + 3 horizontal) -->
  <section class="py-10">
    <div class="container-wide">
      <h2 class="section-title mb-1">Popular Travel Guides</h2>
      <p class="section-subtitle">Our most popular guides chosen by travelers</p>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {guidePosts.length > 0 && (
          <BlogCard
            title={guidePosts[0].data.title}
            description={guidePosts[0].data.description}
            slug={guidePosts[0].slug}
            city={guidePosts[0].data.city}
            category={guidePosts[0].data.category}
            pubDate={guidePosts[0].data.pubDate}
            heroImage={guidePosts[0].data.heroImage}
            readingTime={guidePosts[0].data.readingTime}
            featured={true}
          />
        )}
        <div class="space-y-5">
          {guidePosts.slice(1, 4).map(post => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.slug}
              city={post.data.city}
              category={post.data.category}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              readingTime={post.data.readingTime}
              variant="horizontal"
            />
          ))}
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
