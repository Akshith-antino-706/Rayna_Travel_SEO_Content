---
import { getCollection } from 'astro:content';
import BlogCard from './BlogCard.astro';

interface Props {
  city: string;
  category: string;
  currentSlug: string;
  limit?: number;
}

const { city, category, currentSlug, limit = 3 } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Priority: same city + same category, then same city, then same category
const sameCityCategory = allPosts.filter(
  p => p.data.city === city && p.data.category === category && p.slug !== currentSlug
);
const sameCity = allPosts.filter(
  p => p.data.city === city && p.data.category !== category && p.slug !== currentSlug
);

const related = [...sameCityCategory, ...sameCity].slice(0, limit);
---

{related.length > 0 && (
  <section>
    <h2 class="font-heading text-2xl font-bold text-gray-900 mb-6">
      More About {city}
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {related.map(post => (
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          slug={post.slug}
          city={post.data.city}
          category={post.data.category}
          pubDate={post.data.pubDate}
          heroImage={post.data.heroImage}
          readingTime={post.data.readingTime}
        />
      ))}
    </div>
  </section>
)}
