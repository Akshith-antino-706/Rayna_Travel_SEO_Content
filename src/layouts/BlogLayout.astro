---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import RelatedArticles from '../components/RelatedArticles.astro';
import { SITE_URL } from '../utils/constants';

interface Props {
  title: string;
  description: string;
  city: string;
  country: string;
  category: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  heroImageAlt?: string;
  readingTime: number;
  tags: string[];
  headings: { depth: number; slug: string; text: string }[];
  currentSlug: string;
}

const {
  title, description, city, country, category,
  pubDate, updatedDate, heroImage, heroImageAlt,
  readingTime, tags, headings, currentSlug,
} = Astro.props;

const formattedDate = pubDate.toLocaleDateString('en-US', {
  year: 'numeric', month: 'long', day: 'numeric',
});

const citySlug = city.toLowerCase().replace(/\s+/g, '-');

// Sidebar gallery images â€” reduced to 4, first image uses article hero
const sidebarImages = [
  heroImage
    ? heroImage.replace(/w=\d+/, 'w=300').replace(/h=\d+/, 'h=300')
    : 'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=300&h=300&fit=crop&q=70',
  'https://images.unsplash.com/photo-1518684079-3c830dcef090?w=300&h=300&fit=crop&q=70',
  'https://images.unsplash.com/photo-1526495124232-a04e1849168c?w=300&h=300&fit=crop&q=70',
  'https://images.unsplash.com/photo-1580674684081-7617fbf3d745?w=300&h=300&fit=crop&q=70',
];

const fallbackImage = 'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800&h=450&fit=crop';

// JSON-LD
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  image: heroImage ? (heroImage.startsWith('http') ? heroImage : `${SITE_URL}${heroImage}`) : undefined,
  datePublished: pubDate.toISOString(),
  dateModified: (updatedDate || pubDate).toISOString(),
  author: { '@type': 'Organization', name: 'TravelScope' },
  publisher: { '@type': 'Organization', name: 'TravelScope',
    logo: { '@type': 'ImageObject', url: `${SITE_URL}/favicon.svg` } },
  mainEntityOfPage: { '@type': 'WebPage', '@id': Astro.url.href },
};

const breadcrumbLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE_URL },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: `${SITE_URL}/blog` },
    { '@type': 'ListItem', position: 3, name: `${city} Travel Guide`, item: `${SITE_URL}/${citySlug}-travel-guide` },
    { '@type': 'ListItem', position: 4, name: title },
  ],
};
---

<BaseLayout
  title={title}
  description={description}
  image={heroImage}
  type="article"
  publishedDate={pubDate.toISOString()}
  modifiedDate={(updatedDate || pubDate).toISOString()}
  jsonLd={jsonLd}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />

  <article class="container-wide py-6">
    <!-- Breadcrumb -->
    <nav class="breadcrumb mb-5" aria-label="Breadcrumb">
      <a href="/">Home</a>
      <span class="sep">&rsaquo;</span>
      <a href="/blog">Blog</a>
      <span class="sep">&rsaquo;</span>
      <a href={`/${citySlug}-travel-guide`}>{city}</a>
      <span class="sep">&rsaquo;</span>
      <span class="text-gray-600 text-xs truncate max-w-[200px]">{title}</span>
    </nav>

    <!-- Figma layout: Content left + Image sidebar right -->
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_260px] gap-8">
      <!-- Left: Article Content -->
      <div>
        <!-- Header -->
        <header class="mb-8">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight mb-3">
            {title}
          </h1>

          <p class="text-gray-500 text-sm leading-relaxed mb-4">
            {description}
          </p>

          <div class="flex items-center gap-3 text-xs text-gray-400">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center">
                <svg class="w-3 h-3 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                </svg>
              </div>
              <span>Travel Team</span>
            </div>
            <span class="text-gray-200">|</span>
            <time datetime={pubDate.toISOString()}>{formattedDate}</time>
            <span class="text-gray-200">|</span>
            <span>{readingTime} min read</span>
          </div>
        </header>

        <!-- Hero Image -->
        {heroImage && (
          <div class="mb-8">
            <img
              src={heroImage}
              alt={heroImageAlt || title}
              class="w-full rounded-xl aspect-[16/9] object-cover"
              loading="eager"
              onerror={`this.onerror=null;this.src='${fallbackImage}';`}
            />
          </div>
        )}

        <!-- Article Body -->
        <div class="prose prose-sm sm:prose max-w-none
                    prose-headings:font-bold prose-headings:text-gray-900
                    prose-h2:text-xl prose-h2:mt-8 prose-h2:mb-4
                    prose-h3:text-lg prose-h3:mt-6 prose-h3:mb-3
                    prose-p:text-gray-600 prose-p:leading-relaxed
                    prose-a:text-orange-500 prose-a:no-underline hover:prose-a:underline
                    prose-img:rounded-xl
                    prose-table:text-sm prose-th:bg-gray-50 prose-th:text-left prose-th:px-3 prose-th:py-2
                    prose-td:px-3 prose-td:py-2 prose-td:border-t prose-td:border-gray-100">
          <slot />
        </div>

        <!-- Tags -->
        {tags.length > 0 && (
          <div class="mt-10 pt-6 border-t border-gray-100">
            <div class="flex flex-wrap gap-2">
              {tags.map(tag => (
                <a
                  href={`/blog?q=${encodeURIComponent(tag)}`}
                  class="text-xs bg-gray-50 text-gray-500 px-3 py-1.5 rounded-full border border-gray-100
                         hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition-colors"
                >
                  {tag}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Right: Figma Image Gallery Sidebar -->
      <aside class="hidden lg:block">
        <div class="sticky top-20 space-y-6">
          <!-- Table of Contents (moved above gallery for better UX) -->
          {headings.length > 0 && (
            <TableOfContents headings={headings} />
          )}

          <!-- Image Gallery Grid (reduced to 4 images, 2x2) -->
          <div>
            <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Gallery</h4>
            <div class="image-grid-sidebar">
              {sidebarImages.map((img, i) => (
                <img
                  src={img}
                  alt={`${city} photo ${i + 1}`}
                  class="w-full aspect-square object-cover rounded-lg"
                  loading="lazy"
                />
              ))}
            </div>
          </div>

          <!-- City badge -->
          <a
            href={`/${citySlug}-travel-guide`}
            class="block p-4 bg-orange-50 rounded-xl hover:bg-orange-100 transition-colors"
          >
            <p class="text-xs text-orange-600 font-semibold mb-1">Explore more</p>
            <p class="text-sm font-bold text-gray-900">{city} Travel Guide</p>
            <p class="text-xs text-gray-500 mt-1">View all {city} articles</p>
          </a>
        </div>
      </aside>
    </div>

    <!-- Related Articles (horizontal scroll like Figma) -->
    <div class="mt-14">
      <RelatedArticles city={city} category={category} currentSlug={currentSlug} />
    </div>
  </article>
</BaseLayout>
